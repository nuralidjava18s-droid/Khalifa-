<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  
  <title>Kas Koperasi</title>

<style>
body{
  font-family:Arial;
  margin:0;
  background:#f4f6f9;
  font-size:14px;
}

header{
  background: linear-gradient(to right, #1e90ff, #0f3057);
  color:white;
  padding:14px 20px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  box-shadow:0 3px 10px rgba(0,0,0,0.2);
}

.brand{
  display:flex;
  align-items:center;
  gap:10px;
}

.brand img{
  width:42px;
  height:42px;
  border-radius:50%;
  object-fit:cover;
}

  .brand-text .subtitle{
  font-size:12px;
  opacity:0.9;
}

.brand-text .title{
  font-size:16px;
  font-weight:bold;
}
.container{ padding:15px; }

.card{
  background:white;
  padding:15px;
  margin-bottom:15px;
  border-radius:10px;
  box-shadow:0 3px 8px rgba(0,0,0,.08);
}

input,select{
  width:100%;
  padding:8px;
  margin-bottom:8px;
}

button{
  padding:8px 12px;
  border:none;
  border-radius:6px;
  background:#1e90ff;
  color:white;
  cursor:pointer;
}

.total{ font-weight:bold; font-size:16px; }

.row{
  display:flex;
  justify-content:space-between;
}

.transaksi{
  border-bottom:1px solid #ddd;
  padding:8px 0;
}

.masuk{ color:green; font-weight:bold; }
.keluar{ color:red; font-weight:bold; }
</style>
</head>

<body>

  <header>
  <div class="brand">
    <img src="img/icon-192.png">
     <div class="brand-text">
      <div class="subtitle">Koperasi</div>
      <div class="title">ARFA DRIVER</div>
     </div>
    
       <button onclick="window.location='dashboard.html'">Kembali</button>
   <button onclick="exportPDF()">Export PDF</button>
  </div>
  </header>


<div class="container">

  <!-- SALDO -->
  <div class="card total">
    <div>üíµ Cash : Rp <span id="saldoCash">0</span></div>
    <div>üè¶ Bank : Rp <span id="saldoBank">0</span></div>
    <hr>
    <div>üí∞ Total : Rp <span id="saldoTotal">0</span></div>
  </div>

  <!-- INPUT MANUAL -->
  <div class="card" id="cardInput">
    
    <h3>Input Kas Manual</h3>
   
    <select id="sumberKas">
      <option value="cash">Cash</option>
      <option value="bank">Bank</option>
    </select>

    <select id="tipe">
      <option value="masuk">Kas Masuk</option>
      <option value="keluar">Kas Keluar</option>
    </select>
 
    <input type="date" id="tanggal">
    <input type="number" id="jumlah" placeholder="Jumlah">
    <input type="text" id="keterangan" placeholder="Keterangan">

    <button id="btnSimpan">Simpan</button>
  </div>

  <!-- RIWAYAT -->
  <div class="card">
    <h3>Riwayat Transaksi</h3>
    <div id="riwayat"></div>
  </div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, push, onValue, update,remove, get} 
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDd0s73-qW2uiOlBWR-afybFZzMafCHeSo",
  authDomain: "arfa-c7dee.firebaseapp.com",
  databaseURL: "https://arfa-c7dee-default-rtdb.firebaseio.com",
  projectId: "arfa-c7dee",
  storageBucket: "arfa-c7dee.firebasestorage.app",
  messagingSenderId: "468058520812",
  appId: "1:468058520812:web:f9cbc82fe7e88ecda9b9c9"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const kasRef = ref(db,"koperasi/kas");

/* üî• TAMBAHKAN INI */
let editKey = null;
// ===== ROLE BASE =====
const role = localStorage.getItem("role") || "user";

function isAdmin(){
  return role === "admin";
}

// Sembunyikan form jika bukan admin
document.addEventListener("DOMContentLoaded", ()=>{
  if(!isAdmin()){
    document.getElementById("cardInput").style.display = "none";
  }
});
  
/* FORMAT RUPIAH */
function formatRp(n){
  return Number(n||0).toLocaleString("id-ID");
}

/* SIMPAN MANUAL */
document.getElementById("btnSimpan").addEventListener("click", async ()=>{

  const sumberKas = document.getElementById("sumberKas").value;
  const tipe = document.getElementById("tipe").value;
  const jumlah = Number(document.getElementById("jumlah").value);
  const ket = document.getElementById("keterangan").value;
  const tanggalInput = document.getElementById("tanggal").value;

  if(!jumlah || jumlah<=0){
    alert("Jumlah wajib diisi");
    return;
  }

  if(!tanggalInput){
    alert("Tanggal wajib diisi");
    return;
  }

  const tanggal = new Date(tanggalInput).getTime();

  // üî• MODE UPDATE
  if(editKey){
    const kasItemRef = ref(db, "koperasi/kas/" + editKey);

    await update(kasItemRef,{
      sumberKas,
      tipe,
      jumlah,
      keterangan: ket || "-",
      tanggal
    });

    editKey = null;
    document.getElementById("btnSimpan").innerText = "Simpan";
    alert("Data berhasil diupdate");
  }

    
  // üî• MODE TAMBAH BARU
  else{
    await push(kasRef,{
      sumberKas,
      tipe,
      jumlah,
      keterangan: ket || "-",
      tanggal
    });

    alert("Data berhasil ditambahkan");
  }

  // Reset form
  document.getElementById("jumlah").value="";
  document.getElementById("keterangan").value="";
  document.getElementById("tanggal").value="";
});
  
  
/* LOAD DATA */
onValue(kasRef, snapshot => {

  let masukCash=0, keluarCash=0;
  let masukBank=0, keluarBank=0;

  const riwayatDiv = document.getElementById("riwayat");
  riwayatDiv.innerHTML="";

  if(!snapshot.exists()){
    document.getElementById("saldoCash").innerText = "0";
    document.getElementById("saldoBank").innerText = "0";
    document.getElementById("saldoTotal").innerText = "0";
    return;
  }

  const data = Object.entries(snapshot.val());

  // SORT TERBARU
  data.sort((a,b)=>{
    const tglA = Number(a[1]?.tanggal) || 0;
    const tglB = Number(b[1]?.tanggal) || 0;
    return tglB - tglA;
  });

  data.forEach(([key,i])=>{

    if(!i) return;

    const tglValue = i.tanggal ? Number(i.tanggal) : Date.now();

    const jumlah = Number(i.jumlah) || 0;
    const tipe = i.tipe || "masuk";
    const sumberKas = i.sumberKas || "cash";

    const tglObj = new Date(tglValue);
    const tanggalStr = !isNaN(tglObj)
      ? tglObj.toLocaleString("id-ID")
      : "-";

    if(sumberKas==="cash"){
      if(tipe==="masuk") masukCash+=jumlah;
      else keluarCash+=jumlah;
    }

    if(sumberKas==="bank"){
      if(tipe==="masuk") masukBank+=jumlah;
      else keluarBank+=jumlah;
    }

    const div = document.createElement("div");
    div.className="transaksi";

    div.innerHTML=`
      <div class="row">
        <div>
          <span class="${tipe}">
            ${tipe==="masuk" ? "MASUK" : "KELUAR"}
          </span>
          (${sumberKas.toUpperCase()})
        </div>
        <div class="${tipe}">
          Rp ${formatRp(jumlah)}
        </div>
      </div>
      <div>${i.keterangan || "-"} - ${tanggalStr}</div>
      ${isAdmin() ? '<button class="btnEdit">Edit</button>' : ''}
    `;
    
if(isAdmin()){
 div.querySelector(".btnEdit").addEventListener("click", ()=>{
      editKas(
        key,
        tipe,
        sumberKas,
        jumlah,
        tglValue,
        i.keterangan || "-"
      );
    });
}
    riwayatDiv.appendChild(div);
  });
  
  const saldoCash = masukCash - keluarCash;
  const saldoBank = masukBank - keluarBank;
  const total = saldoCash + saldoBank;

  document.getElementById("saldoCash").innerText = formatRp(saldoCash);
  document.getElementById("saldoBank").innerText = formatRp(saldoBank);
  document.getElementById("saldoTotal").innerText = formatRp(total);

});
  
  window.editKas = function(
  key, tipeLama, sumberLama, jumlahLama, tanggalLama, ketLama
){

  editKey = key;

  document.getElementById("editTipe").value = tipeLama;
  document.getElementById("editSumber").value = sumberLama;
  document.getElementById("editJumlah").value = jumlahLama;
  document.getElementById("editKet").value = ketLama;

  let tglFinal;

  if(tanggalLama){
    tglFinal = new Date(Number(tanggalLama));
  } else {
    // üî• kalau data lama tidak punya tanggal
    tglFinal = new Date(); // isi otomatis hari ini
  }

  const tglFormat = tglFinal.toISOString().split("T")[0];
  document.getElementById("editTanggal").value = tglFormat;

  document.getElementById("modalEdit").style.display = "flex";
};
  
  window.closeModal = function(){
  document.getElementById("modalEdit").style.display = "none";
  editKey = null;

  // Reset field
  document.getElementById("editTanggal").value = "";
  document.getElementById("editJumlah").value = "";
  document.getElementById("editKet").value = "";
};

window.updateKas = async function(){

  if(!editKey) return;

  const sumberKas = document.getElementById("editSumber").value;
  const tipe = document.getElementById("editTipe").value;
  const jumlah = Number(document.getElementById("editJumlah").value);
  const ket = document.getElementById("editKet").value;
  const tanggalInput = document.getElementById("editTanggal").value;

  if(!tanggalInput){
    alert("Tanggal wajib diisi");
    return;
  }

  if(!jumlah || jumlah<=0){
    alert("Jumlah tidak valid");
    return;
  }

  const tanggal = new Date(tanggalInput).getTime();
  const kasItemRef = ref(db, "koperasi/kas/" + editKey);

  await update(kasItemRef,{
    sumberKas,
    tipe,
    jumlah,
    keterangan: ket || "-",
    tanggal
  });

  alert("Data berhasil diupdate");

  closeModal();
};
  
  window.hapusKas = async function(){

  if(!editKey) return;

  const konfirmasi = confirm("Yakin ingin menghapus data ini?");
  if(!konfirmasi) return;

  const kasItemRef = ref(db, "koperasi/kas/" + editKey);

  await remove(kasItemRef);

  alert("Data berhasil dihapus");

  closeModal();
};
  
  // ===== EXPORT PDF KAS =====
// ===== EXPORT PDF KAS (Masuk & Keluar Terpisah) =====
window.exportPDF = async function(){

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  // LOAD LOGO
  const img = new Image();
  img.src = "img/icon-192.png";

  await new Promise(resolve=>{
    img.onload = resolve;
  });

  doc.addImage(img,"PNG",15,10,22,22);

  // HEADER
  doc.setFontSize(16);
  doc.text("KOPERASI ARFA DRIVER",105,18,{align:"center"});

  doc.setFontSize(13);
  doc.text("LAPORAN KAS KOPERASI",105,25,{align:"center"});

  const tanggalCetak = new Date().toLocaleDateString("id-ID");
  doc.setFontSize(10);
  doc.text(`Tanggal Cetak : ${tanggalCetak}`,190,18,{align:"right"});

  // Ambil data terbaru
  
const snapshot = await get(kasRef);
const rows = [];

let masukCash=0, keluarCash=0;
let masukBank=0, keluarBank=0;

if(!snapshot.exists()){
  alert("Data kosong");
  return;
}

const data = Object.values(snapshot.val());

// SORT TANGGAL
data.sort((a,b)=>{
  return (Number(a.tanggal)||0) - (Number(b.tanggal)||0);
});

data.forEach(i=>{
  const jumlah = Number(i?.jumlah)||0;
  const tipe = i?.tipe||"masuk";
  const sumberKas = i?.sumberKas||"cash";

  const tglObj = new Date(Number(i.tanggal)||i.tanggal);
  const tanggalStr = !isNaN(tglObj) ? 
    tglObj.toLocaleDateString("id-ID") : "-";

  let masuk = "";
  let keluar = "";

  if(tipe==="masuk"){
    masuk = "Rp " + formatRp(jumlah);
    if(sumberKas==="cash") masukCash+=jumlah;
    else masukBank+=jumlah;
  }else{
    keluar = "Rp " + formatRp(jumlah);
    if(sumberKas==="cash") keluarCash+=jumlah;
    else keluarBank+=jumlah;
  }

  rows.push([
    tanggalStr,
    i?.keterangan || "-",
    masuk,
    keluar,
    sumberKas.toUpperCase()
  ]);
});

  doc.autoTable({
    head:[["Tanggal","Keterangan","Kas Masuk","Kas Keluar","Sumber"]],
    body:rows,
    startY:40,
    styles:{fontSize:8},
    headStyles:{fillColor:[30,144,255]}
  });

  const saldoCash = masukCash - keluarCash;
  const saldoBank = masukBank - keluarBank;
  const total = saldoCash + saldoBank;

  doc.setFontSize(11);
  doc.text(
    `Saldo Cash : Rp ${formatRp(saldoCash)}`,
    14,
    doc.lastAutoTable.finalY + 10
  );

  doc.text(
    `Saldo Bank : Rp ${formatRp(saldoBank)}`,
    14,
    doc.lastAutoTable.finalY + 16
  );

  doc.text(
    `Total Saldo : Rp ${formatRp(total)}`,
    14,
    doc.lastAutoTable.finalY + 22
  );

  doc.save(`Laporan_Kas_${tanggalCetak.replace(/\//g,"-")}.pdf`);
};
</script>
  
<!-- MODAL EDIT -->
<div id="modalEdit" style="
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.4);
  justify-content:center;
  align-items:center;
  z-index:999;
">

  <div style="
    background:white;
    width:90%;
    max-width:400px;
    padding:20px;
    border-radius:12px;
  ">

    <h3>Edit Transaksi</h3>

    <select id="editSumber">
      <option value="cash">Cash</option>
      <option value="bank">Bank</option>
    </select>

    <select id="editTipe">
      <option value="masuk">Kas Masuk</option>
      <option value="keluar">Kas Keluar</option>
    </select>

    <input type="date" id="editTanggal">
    <input type="number" id="editJumlah" placeholder="Jumlah">
    <input type="text" id="editKet" placeholder="Keterangan">

    <div style="display:flex; gap:10px; margin-top:10px;">

  <button onclick="updateKas()">
    Update
  </button>

  <button onclick="hapusKas()" style="background:#e74c3c;color:white;">
    Hapus
  </button>

  <button onclick="closeModal()" style="background:gray;">
    Batal
  </button>
 </div>
</div>
</body>
</html>
  
  