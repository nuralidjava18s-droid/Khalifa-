<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Laporan Pinjaman & Angsuran - Cetak</title>
<style>
  
body{font-family:Arial,sans-serif;margin:0;padding:0;background:#f4f6f9;}
.container{padding:15px;}
.card{background:white;padding:12px;margin-bottom:12px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.1);}
.table{width:100%;border-collapse:collapse;margin-top:10px;}
.table th,.table td{border:1px solid #ddd;padding:6px;font-size:12px;text-align:left;}
.table th{background:#1e90ff;color:white;font-weight:bold;}
@media print {
  header button{display:none;}
}
     
/* HEADER */  
header{  
  background: linear-gradient(to right, #1e90ff, #0f3057);  
  color:white;  
  padding:14px 20px;  
  display:flex;  
  justify-content:space-between;  
  align-items:center;  
  box-shadow:0 3px 10px rgba(0,0,0,0.2);  
}  
  
.brand{  
  display:flex;  
  align-items:center;  
  gap:10px;  
}  
  
.brand img{  
  width:42px;  
  height:42px;  
  border-radius:50%;  
  object-fit:cover;  
}  
  
.brand-text .subtitle{  
  font-size:12px;  
  opacity:0.9;  
}  
  
.brand-text .title{  
  font-size:16px;  
  font-weight:bold;  
}  
</style>
</head>
<body>
  
  <header>  
  <div class="brand">  
    <img src="img/icon-192.png">  
    <div class="brand-text">  
      <div class="subtitle">Koperasi</div>  
      <div class="title">ARFA DRIVER</div>  
    </div>  
  </div>  
 
  <button onclick="window.location='dashboard.html'">Kembali</button>  
    <button onclick="window.print()">üñ®Ô∏è Cetak / Save PDF</button>

  </header>  
  
  
<div class="container" id="laporanContainer">
  <!-- Data akan dimasukkan di sini -->
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

/* ===== Firebase Config ===== */
const firebaseConfig = {
  apiKey: "AIzaSyDd0s73-qW2uiOlBWR-afybFZzMafCHeSo",
  authDomain: "arfa-c7dee.firebaseapp.com",
  databaseURL: "https://arfa-c7dee-default-rtdb.firebaseio.com",
  projectId: "arfa-c7dee"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* References */
const anggotaRef = ref(db, "koperasi/anggota");
const pinjamanRef = ref(db, "koperasi/pinjaman");
const angsuranRef = ref(db, "koperasi/angsuran");

/* Container */
const container = document.getElementById("laporanContainer");

/* Format Rupiah */
function formatRp(n){ return Number(n||0).toLocaleString("id-ID"); }

/* Format tanggal */
function formatTanggal(tgl){
  const d = new Date(tgl);
  if(isNaN(d)) return tgl;
  return d.toLocaleDateString("id-ID",{day:"2-digit",month:"short",year:"numeric"});
}

async function renderLaporan(){
  container.innerHTML = "<h2>Loading data...</h2>";

  const [anggotaSnap, pinjamanSnap, angsuranSnap] = await Promise.all([
    get(anggotaRef), get(pinjamanRef), get(angsuranRef)
  ]);

  const anggotaData = anggotaSnap.exists()? anggotaSnap.val() : {};
  const pinjamanData = pinjamanSnap.exists()? pinjamanSnap.val() : {};
  const angsuranData = angsuranSnap.exists()? angsuranSnap.val() : {};

  const rekap = {};

  // Rekap pinjaman
  for(const pid in pinjamanData){
    const pin = pinjamanData[pid];
    const aid = pin.anggotaId;
    if(!rekap[aid]) rekap[aid]={nama:pin.nama,totalPinjaman:0,totalAngsuran:0,pinjaman:[],angsuran:[]};
    rekap[aid].totalPinjaman += Number(pin.jumlah||0);
    rekap[aid].pinjaman.push({
      tanggal: pin.tanggal,
      jumlah: pin.jumlah,
      keterangan: pin.keterangan
    });
  }

  // Rekap angsuran
  for(const aid in angsuranData){
    const ang = angsuranData[aid];
    const pin = pinjamanData[ang.pinjamanId];
    if(!pin) continue;
    const anggotaId = pin.anggotaId;
    if(!rekap[anggotaId]) rekap[anggotaId]={nama:pin.nama,totalPinjaman:0,totalAngsuran:0,pinjaman:[],angsuran:[]};
    rekap[anggotaId].totalAngsuran += Number(ang.jumlah||0);
    rekap[anggotaId].angsuran.push({
      tanggal: ang.tanggal,
      jumlah: ang.jumlah,
      keterangan: ang.keterangan
    });
  }

  container.innerHTML = "<h2>Laporan Pinjaman & Angsuran</h2>";

  for(const aid in rekap){
    const r = rekap[aid];
    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <div><strong>Anggota:</strong> ${r.nama}</div>
      <div><strong>Total Pinjaman:</strong> Rp ${formatRp(r.totalPinjaman)}</div>
      <div><strong>Total Angsuran:</strong> Rp ${formatRp(r.totalAngsuran)}</div>
      <div><strong>Sisa:</strong> Rp ${formatRp(r.totalPinjaman - r.totalAngsuran)}</div>
      <table class="table">
        <tr>
          <th>Tanggal</th>
          <th>Jumlah</th>
          <th>Keterangan</th>
        </tr>
        ${r.pinjaman.map(p=>`
          <tr>
            <td>${formatTanggal(p.tanggal)}</td>
            <td>Rp ${formatRp(p.jumlah)}</td>
            <td>Pinjaman</td>
          </tr>
        `).join("")}
        ${r.angsuran.map(a=>`
          <tr>
            <td>${formatTanggal(a.tanggal)}</td>
            <td>Rp ${formatRp(a.jumlah)}</td>
            <td>Angsuran</td>
          </tr>
        `).join("")}
      </table>
    `;
    container.appendChild(card);
  }
}

renderLaporan();
</script>
</body>
</html>