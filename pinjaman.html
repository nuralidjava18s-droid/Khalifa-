<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Koperasi - Pinjaman</title>
<style>
body{font-family:Arial;margin:0;background:#f4f6f9;}
.container{padding:10px;}
input,select{padding:6px;margin-bottom:8px;width:100%;}
button{padding:6px 10px;margin-top:5px;cursor:pointer;border:none;border-radius:5px;background:#1e90ff;color:white;}
button:disabled{background:#aaa;cursor:not-allowed;}
.status{padding:4px 8px;border-radius:6px;font-size:11px;font-weight:bold;color:white;}
.detail-pinjam{display:none;margin-top:8px;background:#f9f9f9;padding:8px;border-radius:6px;}
.total-summary{margin-top:10px;font-weight:bold;}
/* HEADER */  
header{  
  background: linear-gradient(to right, #1e90ff, #0f3057);  
  color:white;  
  padding:14px 20px;  
  display:flex;  
  justify-content:space-between;  
  align-items:center;  
  box-shadow:0 3px 10px rgba(0,0,0,0.2);  
}  
  
.brand{  
  display:flex;  
  align-items:center;  
  gap:10px;  
}  
  
.brand img{  
  width:42px;  
  height:42px;  
  border-radius:50%;  
  object-fit:cover;  
}  
  
.brand-text .subtitle{  
  font-size:12px;  
  opacity:0.9;  
}  
  
.brand-text .title{  
  font-size:16px;  
  font-weight:bold;  
}  
  
.user-section{  
  position:relative;  
  cursor:pointer;  
  font-size:13px;  
}  
  .card{text-align:center;  }
  </style>

<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

</head>
<body>
<header>  
  <div class="brand">  
    <img src="img/icon-192.png">  
    <div class="brand-text">  
      <div class="subtitle">Koperasi</div>  
      <div class="title">ARFA DRIVER</div>  
    </div>  
    <button onclick="window.location='dashboard.html'">Kembali</button>  
  <button onclick="exportPDF()">Export PDF</button>
   </div>
  </header>   
  
  
  <div class = "card">
  <h3>DATA PINJAMAN ANGGOTA</h3>
  </div>
    <div class="container">
   <div class="total-summary">
    Total Pinjaman: Rp <span id="totalPinjaman">0</span>
  </div>

  <!-- Form Tambah Pinjaman -->
  <div id="formPinjaman" class="card">
    <h3>Tambah Pinjaman</h3>
    <input type="text" id="namaPinjaman" placeholder="Nama Anggota / Nasabah">
    <input type="number" id="jumlahPinjaman" placeholder="Jumlah Pinjaman">
    <select id="metodePinjaman">
      <option value="cash">Cash</option>
      <option value="bank">Bank</option>
    </select>
    <input type="text" id="keteranganPinjaman" placeholder="Keterangan (opsional)">
    <button onclick="tambahPinjaman()">Simpan Pinjaman</button>
  </div>

  <!-- Daftar Pinjaman -->
  <div id="cardsContainer"></div>

  <!-- Total -->
 

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, push, onValue } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

/* Firebase Config */
const firebaseConfig = {
  apiKey: "AIzaSyDd0s73-qW2uiOlBWR-afybFZzMafCHeSo",
  authDomain: "arfa-c7dee.firebaseapp.com",
  databaseURL: "https://arfa-c7dee-default-rtdb.firebaseio.com",
  projectId: "arfa-c7dee",
  storageBucket: "arfa-c7dee.firebasestorage.app",
  messagingSenderId: "468058520812",
  appId: "1:468058520812:web:f9cbc82fe7e88ecda9b9c9"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const pinjamanRef = ref(db,"koperasi/pinjaman");
const kasRef = ref(db,"koperasi/kas");

/* Proteksi role admin */
const role = localStorage.getItem("role") || "user";
if(role !== "admin"){
  document.getElementById("formPinjaman").style.display = "none";
}

function formatRp(n){return Number(n||0).toLocaleString("id-ID");}

let dataPinjaman = {};

/* Render daftar pinjaman */
/* Render daftar pinjaman (tanpa status + tambah tanggal) */
function render(){
  const container = document.getElementById("cardsContainer");
  container.innerHTML="";
  let total = 0;

  for(const k in dataPinjaman){
    const p = dataPinjaman[k];
    total += Number(p.jumlah||0);

    const card = document.createElement("div");
    card.className="card";
    card.innerHTML=`
      <h3 onclick="toggleDetail('${k}')">
        ${p.nama}
      </h3>
      Tanggal Pinjam: ${p.tanggal || "-"}<br>
      Jumlah Pinjaman: Rp ${formatRp(p.jumlah)}<br>
      Metode: ${p.metode || "-"}<br>
      Keterangan: ${p.keterangan || "-"}
      <div id="detail-${k}" class="detail-pinjam">
        Belum ada angsuran.
      </div>
    `;
    container.appendChild(card);
  }

  document.getElementById("totalPinjaman").innerText = formatRp(total);
}
/* ðŸ”¹ Realtime listener pinjaman */
onValue(pinjamanRef,(snap)=>{
  dataPinjaman = snap.exists()?snap.val():{};
  render();
});

/* ðŸ”¹ Tambah pinjaman */
window.tambahPinjaman=async function(){
  if(role!=="admin"){alert("Tidak punya akses");return;}

  const nama = document.getElementById("namaPinjaman").value.trim();
  const jumlah = Number(document.getElementById("jumlahPinjaman").value);
  const metode = document.getElementById("metodePinjaman").value;
  const ket = document.getElementById("keteranganPinjaman").value.trim();
  const tanggal = new Date().toLocaleString();

  if(!nama || !jumlah || jumlah<=0){alert("Data tidak valid"); return;}

  // Simpan pinjaman
  const newRef = await push(pinjamanRef,{
    nama: nama,
    jumlah: jumlah,
    keterangan: ket,
    metode: metode,
    tanggal: tanggal,
    lunas:false
  });

  // Simpan ke kas otomatis
  await push(kasRef,{
    tanggal: tanggal,
    keterangan:`Pinjaman - ${nama}`,
    jenis:"masuk",
    cash: metode==="cash"?jumlah:0,
    bank: metode==="bank"?jumlah:0
  });

  alert("Pinjaman berhasil disimpan");
  document.getElementById("namaPinjaman").value="";
  document.getElementById("jumlahPinjaman").value="";
  document.getElementById("keteranganPinjaman").value="";
};
/* ðŸ”¹ Export PDF + Logo */
window.exportPDF = async function(){

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  // === LOAD LOGO ===
  const img = new Image();
  img.src = "img/icon-192.png"; // pastikan path benar

  await new Promise(resolve=>{
    img.onload = resolve;
  });

  // Tambahkan logo
  doc.addImage(img, "PNG", 15, 10, 22, 22);

  // === HEADER ===
  doc.setFontSize(16);
  doc.text("KOPERASI ARFA DRIVER",105,18,{align:"center"});

  doc.setFontSize(13);
  doc.text("LAPORAN PINJAMAN",105,25,{align:"center"});

  const tanggalCetak = new Date().toLocaleDateString("id-ID");
  doc.setFontSize(10);
  doc.text(`Tanggal Cetak : ${tanggalCetak}`,190,18,{align:"right"});

  // === TABEL DATA ===
  const rows=[];
  for(const k in dataPinjaman){
    const p = dataPinjaman[k];
    rows.push([
      p.nama,
      p.tanggal || "-",
      `Rp ${formatRp(p.jumlah)}`,
      p.metode || "-",
      p.keterangan || "-"
    ]);
  }

  doc.autoTable({
    head:[["Nama","Tanggal Pinjam","Jumlah Pinjaman","Metode","Keterangan"]],
    body:rows,
    startY:40,
    styles:{fontSize:8},
    headStyles:{fillColor:[30,144,255]}
  });

  doc.save(
    `Laporan_Pinjaman_${tanggalCetak.replace(/\//g,"-")}.pdf`
  );
};
</script>
</body>
</html>






